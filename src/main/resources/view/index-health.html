@import java.lang.*, java.util.* org.elasticsearch.action.admin.cluster.health.*, org.elasticsearch.action.admin.cluster.stats.*, org.elasticsearch.action.admin.indices.stats.*, org.elasticsearch.common.xcontent.*
@import org.elasticsearch.action.admin.cluster.node.info.*, org.elasticsearch.action.admin.cluster.node.stats.*, org.elasticsearch.action.admin.cluster.state.*, org.elasticsearch.cluster.routing.*, org.elasticsearch.cluster.health.*
@import sirius.search.controller.*

@args ClusterHealthResponse clusterHealth, ClusterStatsResponse clusterStats,
NodesInfoResponse nodesInfo, NodesStatsResponse nodesStats,
IndicesStatsResponse indicesStats,
String clusterStateString,
Map<String, Map<Integer, List<ShardRouting>>> allShardRoutings,
Map<java.lang.String, String> nodeStatsMap,
Map<java.lang.String, String> indexMetaData,
Map<java.lang.String, String> indexStatusMap,
Map<java.lang.String, String> nodeInfoMap,
sirius.search.controller.IndexHealthController.NumberFormatter formatter
@extends(view.wondergem.template.html, title: ("Elasticsearch State"))

@section(head) {
    <style>
        .GRAY {
            color: #555555;
        }
        .GREEN {
            color: #168d12;
        }
        .RED {
            color: #9f3d33;
        }
        .YELLOW {
            color: rgb(209, 170, 0);
        }
        .STARTED {
            background-color: #99dd88;
        }
        .UNASSIGNED {
            background-color: #999;
        }
        .RELOCATING {
            background-color: #dc88dd;
        }
        INITIALIZING {
            background-color: #dddc88;
        }
    </style>
}

@section(breadcrumbs) {
    <li><a href="@prefix/system/index">Elasticsearch State</a></li>
}

@{ String clusterStateTmp = "";
   try { clusterStateTmp = ClusterHealthStatus.fromValue(clusterHealth.getStatus().value()).name(); } catch(Exception e) {}
   final String clusterState = clusterStateTmp;
}

@pageHeader() {
    <span class="@clusterState">Cluster State</span> <small>@clusterHealth.getClusterName()</small>
    <div class="pull-right">
        @//--------------------------cluster info button----------------------------------------------------------------
        <div class="dropdown" style="display:inline-block">
            <button id="clusterInfoButton" class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">
                Cluster Info
            </button>
            <ul class="dropdown-menu" id="clusterInfoDropdown">
                <li> <a style="cursor:pointer" data-toggle="modal" data-target="#clusterState">Cluster State</a></li>
                <li> <a style="cursor:pointer" data-toggle="modal" data-target="#clusterHealth">Cluster Health</a><li/>
                <li> <a style="cursor:pointer" data-toggle="modal" data-target="#nodesStats">Nodes Stats</a></li>
                <li> <a style="cursor:pointer" data-toggle="modal" data-target="#nodesInfo">Nodes Info</a></li>
                <li> <a style="cursor:pointer" data-toggle="modal" data-target="#indicesStats">Indices Stats</a></li>
            </ul>
        </div>
        <a class="btn btn-default" href="/assets/es-head/index.html">HEAD</a>
        <a class="btn btn-default" href="/system/index"><i class="fa fa-refresh"></i></a>
    </div>
    <div class="clearfix"></div>
}

@invoke("index-health-infowindow", "clusterState", "Cluster State", clusterStateString)
@invoke("index-health-infowindow", "clusterHealth", "Cluster Health", clusterHealth.toString())
@invoke("index-health-infowindow", "nodesInfo", "Nodes Info", nodesInfo.toString())
@invoke("index-health-infowindow", "nodesStats", "Nodes Stats", nodesStats.toString())
@invoke("index-health-infowindow", "indicesStats", "Indices Stats", indicesStats.toString())


<script type="text/javascript">
    function showJson(id) {
         $('#' + id).css("display", "block");
    }

    function openInfoDropdown(id) {
        $('#' + id).toggle('fast');
    }
</script>


<h2>General</h2>
<table class="table table-striped">
    <tr>
        <td style="overflow: hidden">
            Cluster Status
        </td>
        <td class="@clusterState align-right" style="overflow: hidden">
            @clusterHealth.getStatus()
        </td>
    </tr>
    <tr>
        <td style="overflow: hidden">
            Cluster Docs
        </td>
        <td class="align-right" style="overflow: hidden">
            @formatter.formatLong(clusterStats.getIndicesStats().getDocs().getCount())
        </td>
    </tr>
    <tr>
        <td style="overflow: hidden">
            Indexsize
        </td>
        <td class="align-right" style="overflow: hidden">
            @formatter.formatLong(clusterStats.getIndicesStats().getStore().size().getMb()) MB
        </td>
    </tr>
    <tr>
        <td style="overflow: hidden">
            # Nodes
        </td>
        <td class="align-right" style="overflow: hidden">
            @clusterHealth.getNumberOfNodes()
        </td>
    </tr>
    <tr>
        <td style="overflow: hidden">
            Active Shards
        </td>
        <td class="align-right" style="overflow: hidden">
            @clusterHealth.getActiveShards()
        </td>
    </tr>
    <tr>
        <td style="overflow: hidden">
            Active Primary Shards
        </td>
        <td class="align-right" style="overflow: hidden">
            @clusterHealth.getActivePrimaryShards()
        </td>
    </tr>
    <tr>
        <td style="overflow: hidden">
            Initializing Shards
        </td>
        <td class="align-right" style="overflow: hidden">
            @clusterHealth.getInitializingShards()
        </td>
    </tr>
    <tr>
        <td style="overflow: hidden">
            Relocating Shards
        </td>
        <td class="align-right" style="overflow: hidden">
            @clusterHealth.getRelocatingShards()
        </td>
    </tr>
    <tr>
        <td style="overflow: hidden">
            Unassigned Shards
        </td>
        <td class="align-right" style="overflow: hidden">
            @clusterHealth.getUnassignedShards()
        </td>
    </tr>
    <tr>
        <td style="overflow: hidden">
            Delayed Unassigned Shards
        </td>
        <td class="align-right" style="overflow: hidden">
            @clusterHealth.getDelayedUnassignedShards()
        </td>
    </tr>
    <tr>
        <td style="overflow: hidden">
            Pending Tasks
        </td>
        <td class="align-right" style="overflow: hidden">
            @clusterHealth.getNumberOfPendingTasks()
        </td>
    </tr>
</table>


<h2>Nodes</h2>
    <table class="table table-striped">
        @for(NodeStats nodeStats : nodesStats.getNodes()) {
        <tr>
            @{String nodeStatId = "stats" + nodeStats.getNode().getName();}
            @{String nodeInfoId = "info" + nodeStats.getNode().getName();}
            @invoke("index-health-infowindow", nodeStatId, "Node Stats", nodeStatsMap.get(nodeStats.getNode().getName()))
            @invoke("index-health-infowindow", nodeInfoId, "Node Info", nodeInfoMap.get(nodeStats.getNode().getName()))

            <td style="vertical-align:middle">
                @nodeStats.getNode().getName()
            </td>
            <td class="align-right">
                <div class="dropdown"  style="display:inline-block">
                    <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">
                        Node Info
                    </button>
                    <ul id="nodeInfoDropdown" class="dropdown-menu">
                        <li> <a style="cursor:pointer" data-toggle="modal" data-target="#@nodeStatId">Node Stats</a></li>
                        <li> <a style="cursor:pointer" data-toggle="modal" data-target="#@nodeInfoId">Node Info</a></li>
                    </ul>
                </div>
            </td>
        </tr>
        }
    </table>
    <table class="table table-striped">
        <tr>
            @{ final String versions = sirius.kernel.commons.Strings.join(clusterStats.getNodesStats().getVersions(), ","); }
            <td style="overflow: hidden">
                Versions
            </td>
            <td class="align-right" style="overflow: hidden">
                @versions
            </td>
        </tr>
        <tr>
            <td style="overflow: hidden">
                Available Processors
            </td>
            <td class="align-right" style="overflow: hidden">
                @clusterStats.getNodesStats().getOs().getAvailableProcessors()
            </td>
        </tr>
        <tr>
            <td style="overflow: hidden">
                CPU Percent
            </td>
            <td class="align-right" style="overflow: hidden">
                @clusterStats.getNodesStats().getProcess().getCpuPercent()
            </td>
        </tr>
        <tr>
            <td style="overflow: hidden">
                Average open file descriptors
            </td>
            <td class="align-right" style="overflow: hidden">
                @clusterStats.getNodesStats().getProcess().getAvgOpenFileDescriptors()
            </td>
        </tr>
        <tr>
            <td style="overflow: hidden">
                JVM-threads
            </td>
            <td class="align-right" style="overflow: hidden">
                @clusterStats.getNodesStats().getJvm().getThreads()
            </td>
        </tr>
        <tr>
            <td style="overflow: hidden">
                Max-Uptime
            </td>
            <td class="align-right" style="overflow: hidden">
                @clusterStats.getNodesStats().getJvm().getMaxUpTime().toString()
            </td>
        </tr>
        <tr>
            <td style="overflow: hidden">
                Used Heap
            </td>
            <td class="align-right" style="overflow: hidden">
                @formatter.formatLong(clusterStats.getNodesStats().getJvm().getHeapUsed().getMb()) MB
            </td>
        </tr>
    </table>


<h2>Indices</h2>
    @for(ClusterIndexHealth indexHealth : clusterHealth.getIndices().values()){
    @{ String status = "";
    try { status = ClusterHealthStatus.fromValue(indexHealth.getStatus().value()).name(); } catch(Exception e) {}
    }
    <table class="table table-striped" style="table-layout: fixed; word-wrap: break-word;">
        <tr>
            <td class="@status" style="vertical-align:middle">
                @indexHealth.getIndex()
            </td>
            <td>
                @{ int i = 0; }
                @{ int j = 0; }
                @for(Map.Entry<Integer, List<ShardRouting>> shardRouting : allShardRoutings.get(indexHealth.getIndex()).entrySet()) {
                    @for(ShardRouting routing : shardRouting.getValue()) {

                        @{String shardId = i+ "-" + j}
                        @{String shardRoutingState = routing.state().toString()}
                        @{ String shardInfo = "";
                        try {
                        shardInfo = routing.toXContent(XContentFactory.jsonBuilder().humanReadable(true).prettyPrint(),
                        ToXContent.EMPTY_PARAMS).string();
                        } catch(IOException e) {}
                        }

                        @invoke("index-health-infowindow", shardId, "Shard Routing", shardInfo)
                        <a class="@shardRoutingState" style="width:40px; height:40px; border: 3px solid black; display:inline-block; text-align:center;
                                      cursor:pointer" data-toggle="modal" data-target="#@shardId">
                            <p style="font-size:35px; position:relative; bottom:8px; color: #000000;">@shardRouting.getKey()</p>
                        </a>
                        @{j++;}
                    }
                @{i++;}
                }
            </td>
            @{ String statusId = "status" + indexHealth.getIndex() }
            @{ String metaDataId = "metaData" + indexHealth.getIndex() }
            @invoke("index-health-infowindow", statusId, "Index Status", indexStatusMap.get(indexHealth.getIndex()))
            @invoke("index-health-infowindow", metaDataId, "Index Metadata", indexMetaData.get(indexHealth.getIndex()))
            <td class="align-right" style="vertical-align:middle">
                <div class="dropdown" style="float:right">
                    <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">
                        Index Info
                    </button>
                    <ul class="dropdown-menu" id="indexInfoDropdown">
                        <li><a style="cursor:pointer" data-toggle="modal" data-target="#@statusId">Index Status</a></li>
                        <li><a style="cursor:pointer" data-toggle="modal" data-target="#@metaDataId">Index Metadata</a></li>
                    </ul>
                </div>
            </td>
        </tr>
        <tr>
            <td colspan="2" style="overflow: hidden">
                Status
            </td>
            <td class="@status align-right" style="overflow: hidden">
                @status
            </td>
        </tr>
        <tr>
            <td colspan="2" style="overflow: hidden">
                # Shards
            </td>
            <td class="@status align-right" style="overflow: hidden">
                @indexHealth.getNumberOfShards()
            </td>
        </tr>
        <tr>
            <td colspan="2" style="overflow: hidden">
                # Replicas
            </td>
            <td class="@status align-right" style="overflow: hidden">
                @indexHealth.getNumberOfReplicas()
            </td>
        </tr>
        <tr>
            <td colspan="2" style="overflow: hidden">
                # Docs
            </td>
            <td class="@status align-right" style="overflow: hidden">
                @formatter.formatLong(indicesStats.getIndex(indexHealth.getIndex()).getPrimaries().getDocs().getCount())
            </td>
        </tr>
        <tr>
            <td colspan="2" style="overflow: hidden">
                Size
            </td>
            <td class="@status align-right" style="overflow: hidden">
                @formatter.formatLong(indicesStats.getIndex(indexHealth.getIndex()).getPrimaries().getTotalMemory().getMb()) MB
            </td>
        </tr>
    </table>
    }

<h2>Memory</h2>
<table class="table table-striped">
    <tr>
        <td style="overflow: hidden">
            Total Disk Space
        </td>
        <td class="align-right" style="overflow: hidden">
            @formatter.formatLong(clusterStats.getNodesStats().getFs().getTotal().getMb()) MB
        </td>
    </tr>
    <tr>
        <td style="overflow: hidden">
            Available Disk Space
        </td>
        <td class="align-right" style="overflow: hidden">
            @formatter.formatLong(clusterStats.getNodesStats().getFs().getAvailable().getMb()) MB
        </td>
    </tr>
    <tr>
        <td style="overflow: hidden">
            Free Disk Space
        </td>
        <td class="align-right" style="overflow: hidden">
            @formatter.formatLong(clusterStats.getNodesStats().getFs().getFree().getMb()) MB
        </td>
    </tr>
    <tr>
        <td style="overflow: hidden">
            Fielddata
        </td>
        <td class="align-right" style="overflow: hidden">
            @formatter.formatLong(clusterStats.getIndicesStats().getFieldData().getMemorySize().getMb()) MB
        </td>
    </tr>
    <tr>
        <td style="overflow: hidden">
            Segments (#@clusterStats.getIndicesStats().getSegments().getCount())
        </td>
        <td class="align-right" style="overflow: hidden">
            @formatter.formatLong(clusterStats.getIndicesStats().getSegments().getMemory().getMb()) MB per segment
        </td>
    </tr>
    <tr>
        <td style="overflow: hidden">
            Completion
        </td>
        <td class="align-right" style="overflow: hidden">
            @formatter.formatLong(clusterStats.getIndicesStats().getCompletion().getSize().getMb()) MB
        </td>
    </tr>
    <tr>
        <td style="overflow: hidden">
            Query Cache
        </td>
        <td class="align-right" style="overflow: hidden">
            @formatter.formatLong(clusterStats.getIndicesStats().getQueryCache().getMemorySize().getMb()) MB
        </td>
    </tr>
</table>

<h2>Cache</h2>
<table class="table table-striped">
    <tr>
        <td style="overflow: hidden">
            Query Cache Size
        </td>
        <td class="align-right" style="overflow: hidden">
            @formatter.formatLong(clusterStats.getIndicesStats().getQueryCache().getCacheSize())
        </td>
    </tr>
    <tr>
        <td style="overflow: hidden">
            Query Cache Lookups
        </td>
        <td class="align-right" style="overflow: hidden">
            @formatter.formatLong(clusterStats.getIndicesStats().getQueryCache().getTotalCount())
        </td>
    </tr>
    <tr>
        <td style="overflow: hidden">
            Query Cache Hits
        </td>
        <td class="align-right" style="overflow: hidden">
            @formatter.formatLong(clusterStats.getIndicesStats().getQueryCache().getHitCount())
        </td>
    </tr>
    <tr>
        <td style="overflow: hidden">
            Query Cache Misses
        </td>
        <td class="align-right" style="overflow: hidden">
            @formatter.formatLong(clusterStats.getIndicesStats().getQueryCache().getMissCount())
        </td>
    </tr>
</table>

